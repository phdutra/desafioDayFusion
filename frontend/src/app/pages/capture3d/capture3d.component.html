<div class="capture-container fade-in-up">
  <h2 class="gradient-text page-title">Face Liveness 3D - Anti-Spoof</h2>

  <!-- Se√ß√£o de Informa√ß√µes -->
  <section class="capture-section">
    <div class="info-container">
      <div class="info-content">
        <div class="info-icon">üîê</div>
        <h3 class="info-title">Verifica√ß√£o 3D com Detec√ß√£o de Liveness</h3>
        <p class="info-description">
          Tecnologia avan√ßada que previne fraudes com deepfakes e fotos est√°ticas. 
          O sistema detecta movimentos reais em tempo real.
        </p>
        
        <div class="features-list">
          <div class="feature-item">
            <span class="feature-icon">‚úÖ</span>
            <span class="feature-text">Detec√ß√£o de movimento real</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">‚úÖ</span>
            <span class="feature-text">Anti-deepfake</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">‚úÖ</span>
            <span class="feature-text">Anti-spoofing</span>
          </div>
        </div>

        <div class="warning-message" *ngIf="livenessError">
          <p class="error-text">‚ö†Ô∏è {{ livenessError }}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Controles -->
  <div class="controls-section">
    <!-- CORRE√á√ÉO: Bot√£o "Iniciar Verifica√ß√£o 3D" destacado em AMARELO - aparece sempre na p√°gina -->
    <button 
      class="btn btn-yellow-highlight btn-large" 
      (click)="openCameraModal()" 
      [disabled]="livenessLoading || sessionActive">
      <span class="btn-icon">‚ñ∂</span>
      <span>Iniciar Verifica√ß√£o 3D</span>
    </button>

    <button 
      class="btn btn-secondary btn-large" 
      (click)="stopSession()" 
      *ngIf="sessionActive">
      <span class="btn-icon">‚èπÔ∏è</span>
      Finalizar Verifica√ß√£o
    </button>
  </div>

  <!-- Modal da C√¢mera (Reutiliz√°vel) -->
  <app-camera-modal
    #cameraModal
    [isOpen]="showCameraModal"
    mode="3d"
    [processingResults]="processingResults"
    [processingProgress]="processingProgress"
    [useRealWidget]="showLivenessWidget"
    (close)="closeCameraModal()"
    (livenessStart)="onLivenessStart()"
    (livenessComplete)="onLivenessComplete($event)"
  ></app-camera-modal>

  <!-- Container para FaceLivenessDetector oficial -->
  <!-- IMPORTANTE: Widget s√≥ aparece quando modal est√° aberto E showLivenessWidget √© true -->
  <div class="widget-container" *ngIf="showLivenessWidget && showCameraModal">
    <div id="liveness-container"></div>
  </div>

  <!-- Tela de Processamento (exibida na p√°gina principal ap√≥s fechar modal) -->
  <section class="processing-section" *ngIf="processingResults && !livenessResult">
    <div class="processing-card">
      <div class="processing-content">
        <div class="processing-animation">
          <div class="processing-icon-wrapper">
            <div class="processing-icon">
              <svg viewBox="0 0 100 100" class="processing-svg">
                <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(34, 197, 94, 0.3)" stroke-width="4" />
                <circle cx="50" cy="50" r="40" fill="none" stroke="#22c55e" stroke-width="4" 
                        [attr.stroke-dasharray]="251.2"
                        [attr.stroke-dashoffset]="251.2 - (251.2 * processingProgress / 100)"
                        stroke-linecap="round"
                        transform="rotate(-90 50 50)"
                        class="processing-circle" />
              </svg>
              <div class="processing-checkmark" *ngIf="processingProgress >= 100">‚úì</div>
            </div>
          </div>
          
          <h2 class="processing-title">Gerando Resultados</h2>
          <p class="processing-subtitle">Processando an√°lise facial e verificando liveness...</p>
          
          <!-- Barra de progresso animada -->
          <div class="progress-bar-container">
            <div class="progress-bar-background">
              <div class="progress-bar-fill" [style.width.%]="processingProgress">
                <div class="progress-bar-shine"></div>
              </div>
            </div>
            <div class="progress-percentage">{{ processingProgress }}%</div>
          </div>
          
          <!-- Mensagens de status -->
          <div class="processing-status-messages">
            <div class="status-message" *ngIf="processingProgress < 30">
              <span class="status-dot"></span>
              <span>Conectando com AWS Rekognition...</span>
            </div>
            <div class="status-message" *ngIf="processingProgress >= 30 && processingProgress < 60">
              <span class="status-dot"></span>
              <span>Processando frames de v√≠deo...</span>
            </div>
            <div class="status-message" *ngIf="processingProgress >= 60 && processingProgress < 90">
              <span class="status-dot"></span>
              <span>Analisando liveness e gerando imagens...</span>
            </div>
            <div class="status-message" *ngIf="processingProgress >= 90 && processingProgress < 100">
              <span class="status-dot"></span>
              <span>Finalizando an√°lise...</span>
            </div>
            <div class="status-message success" *ngIf="processingProgress >= 100">
              <span class="status-dot success"></span>
              <span>An√°lise conclu√≠da!</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Resultado do Liveness -->
  <section class="result-section" *ngIf="livenessResult">
    <div class="result-card" [class.approved]="livenessResult.livenessDecision === 'LIVE'" [class.rejected]="livenessResult.livenessDecision === 'SPOOF'">
      <div class="result-header">
        <div class="result-status">
          <span class="status-icon-large">
            {{ livenessResult.livenessDecision === 'LIVE' ? '‚úÖ' : '‚ùå' }}
          </span>
          <div class="status-info">
            <h3 class="result-title">Verifica√ß√£o 3D Conclu√≠da</h3>
            <div class="status-session-info" *ngIf="livenessResult.status">
              <span class="status-session-label">Status da sess√£o:</span>
              <span class="status-session-value" [class.created]="getStatusString() === 'CREATED'" 
                    [class.succeeded]="getStatusString() === 'SUCCEEDED'" 
                    [class.failed]="getStatusString() === 'FAILED' || getStatusString() === 'EXPIRED'">
                {{ getStatusString() }}
              </span>
              <span class="status-session-confidence" *ngIf="livenessResult.confidence">
                Confian√ßa: {{ (livenessResult.confidence * 100) | number:'1.1-1' }}%
              </span>
            </div>
            <span class="status-badge" [class.approved]="livenessResult.livenessDecision === 'LIVE'" [class.rejected]="livenessResult.livenessDecision === 'SPOOF'">
              {{ livenessResult.livenessDecision === 'LIVE' ? 'APROVADO' : livenessResult.livenessDecision === 'SPOOF' ? 'SPOOF DETECTADO' : 'INDETERMINADO' }}
            </span>
          </div>
        </div>
        
        <div class="result-score">
          <div class="score-value">{{ (livenessResult.confidence * 100) | number:'1.1-1' }}%</div>
          <div class="score-label">Confian√ßa</div>
        </div>
      </div>

      <div class="result-message" *ngIf="livenessResult.message">
        <p>{{ livenessResult.message }}</p>
      </div>

      <!-- An√°lise Detalhada do Score (sempre exibir conforme README) -->
      <div class="result-analysis" *ngIf="livenessResult">
        <h4 class="analysis-title">üìä An√°lise Detalhada</h4>
        
        <!-- Score Principal (sempre exibir) -->
        <div class="analysis-section">
          <div class="score-badge-large" style="text-align: center; margin: 20px auto;">
            <span class="score-label-large">Score de Confian√ßa</span>
            <span class="score-value-large">{{ (livenessResult.confidence * 100) | number:'1.1-1' }}%</span>
          </div>
        </div>
        
        <!-- Thumbnails na an√°lise detalhada -->
        <div class="analysis-thumbnails" *ngIf="livenessResult.referenceImageUrl || (livenessResult.auditImageUrls && livenessResult.auditImageUrls.length > 0)">
          <h5 class="section-title">üì∑ Imagens Capturadas</h5>
          <div class="thumbnails-grid">
            <!-- Imagem de refer√™ncia -->
            <div class="thumbnail-item" *ngIf="livenessResult.referenceImageUrl">
              <div class="thumbnail-image-wrapper">
                <img [src]="livenessResult.referenceImageUrl" alt="Refer√™ncia" class="thumbnail-image" (error)="handleImageError($event)">
                <div class="thumbnail-overlay">
                  <span class="thumbnail-badge">Refer√™ncia</span>
                </div>
              </div>
              <span class="thumbnail-label">Imagem de Refer√™ncia</span>
            </div>
            <!-- Imagens de auditoria -->
            <div class="thumbnail-item" *ngFor="let imageUrl of livenessResult.auditImageUrls; let i = index">
              <div class="thumbnail-image-wrapper">
                <img [src]="imageUrl" [alt]="'Auditoria ' + (i + 1)" class="thumbnail-image" (error)="handleImageError($event)">
                <div class="thumbnail-overlay">
                  <span class="thumbnail-badge">Frame {{ i + 1 }}</span>
                </div>
              </div>
              <span class="thumbnail-label">Frame {{ i + 1 }} de Auditoria</span>
            </div>
          </div>
        </div>
        
        <div class="analysis-section" *ngIf="livenessResult.qualityAssessment">
          <div class="quality-badge" [class.excellent]="livenessResult.qualityAssessment === 'EXCELLENT'"
               [class.good]="livenessResult.qualityAssessment === 'GOOD'"
               [class.fair]="livenessResult.qualityAssessment === 'FAIR'"
               [class.poor]="livenessResult.qualityAssessment === 'POOR'">
            <span class="quality-label">Qualidade:</span>
            <span class="quality-value">{{ livenessResult.qualityAssessment }}</span>
            <span class="quality-score" *ngIf="livenessResult.qualityScore">
              ({{ livenessResult.qualityScore | number:'1.1-1' }}%)
            </span>
          </div>
        </div>

        <div class="analysis-section" *ngIf="livenessResult.lowScoreReasons && livenessResult.lowScoreReasons.length > 0">
          <h5 class="section-title">‚ö†Ô∏è Raz√µes para Score Baixo</h5>
          <ul class="reasons-list">
            <li *ngFor="let reason of livenessResult.lowScoreReasons">{{ reason }}</li>
          </ul>
        </div>

        <div class="analysis-section" *ngIf="livenessResult.recommendations && livenessResult.recommendations.length > 0">
          <h5 class="section-title">üí° Recomenda√ß√µes</h5>
          <ul class="recommendations-list">
            <li *ngFor="let rec of livenessResult.recommendations">{{ rec }}</li>
          </ul>
        </div>
      </div>


      <!-- Imagem de Refer√™ncia -->
      <div class="result-images-section" *ngIf="livenessResult.referenceImageUrl">
        <h4 class="images-section-title">üì∏ Imagem de Refer√™ncia</h4>
        <div class="reference-image-container">
          <img [src]="livenessResult.referenceImageUrl" alt="Refer√™ncia" class="reference-image">
          <p class="image-caption">Frame capturado para verifica√ß√£o facial downstream</p>
        </div>
      </div>

      <!-- Imagens de Auditoria -->
      <div class="result-images-section" *ngIf="livenessResult.auditImageUrls && livenessResult.auditImageUrls.length > 0">
        <h4 class="images-section-title">üñºÔ∏è Imagens de Auditoria</h4>
        <p class="images-section-subtitle">At√© 4 frames extra√≠dos do v√≠deo selfie para auditoria do processo</p>
        <div class="audit-images-grid">
          <div class="audit-image-item" *ngFor="let imageUrl of livenessResult.auditImageUrls; let i = index">
            <img [src]="imageUrl" [alt]="'Audit image ' + (i + 1)" class="audit-image">
            <span class="audit-image-label">Frame {{ i + 1 }}</span>
          </div>
        </div>
      </div>

      <!-- Mensagem quando n√£o h√° thumbnails -->
      <div class="result-info" *ngIf="livenessResult.status !== 'CREATED' && (!livenessResult.auditImageUrls || livenessResult.auditImageUrls.length === 0) && !livenessResult.referenceImageUrl">
        <div class="info-icon">‚ÑπÔ∏è</div>
        <div class="info-content">
          <p>Nenhuma imagem de refer√™ncia ou auditoria dispon√≠vel.</p>
          <p *ngIf="livenessResult.status === 'FAILED' || livenessResult.status === 'EXPIRED'">
            Status da sess√£o: {{ livenessResult.status }}
          </p>
        </div>
      </div>

      <button class="btn btn-secondary btn-retry" (click)="resetResult()">
        <span class="btn-icon">üîÑ</span>
        Nova Verifica√ß√£o
      </button>
    </div>
  </section>

  <!-- Status da API -->
  <section class="status-section">
    <div class="status-content">
      <h3 class="status-title">üìä Status da Implementa√ß√£o</h3>
      <div class="status-grid">
        <div class="status-item approved">
          <div class="status-icon">‚úÖ</div>
          <div class="status-info">
            <div class="status-label">Backend API</div>
            <div class="status-value">Pronto (AWS SDK 4.x)</div>
          </div>
        </div>
        <div class="status-item approved">
          <div class="status-icon">‚úÖ</div>
          <div class="status-info">
            <div class="status-label">Frontend UI</div>
            <div class="status-value">WebRTC Implementado</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
