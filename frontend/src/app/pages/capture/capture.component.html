<div class="capture-container fade-in-up">
  <h2 class="gradient-text page-title">Captura e ValidaÃ§Ã£o Facial</h2>

  <!-- SeÃ§Ã£o de Captura de Selfie -->
  <section class="capture-section">
    <div class="selfie-container">
      <!-- Preview da selfie capturada -->
      <div class="selfie-preview" *ngIf="selfieDataUrl">
        <div class="preview-label">âœ… Selfie Capturada com Sucesso!</div>
        <div class="preview-image-wrapper">
          <img [src]="selfieDataUrl" alt="Selfie preview">
        </div>
        <button class="btn btn-secondary btn-retake" (click)="retakePhoto()">
          <span class="btn-icon">ğŸ”„</span>
          Tirar Novamente
        </button>
      </div>
      
      <!-- BotÃµes para captura -->
      <div class="capture-trigger" *ngIf="!selfieDataUrl">
        <div class="trigger-content">
          <div class="trigger-icon">ğŸ“¸</div>
          <h3 class="trigger-title">Capturar Selfie</h3>
          <p class="trigger-description">Escolha o tipo de verificaÃ§Ã£o</p>
          
          <div class="capture-options">
            <button class="btn btn-primary btn-large" (click)="openCameraModal()">
              <span class="btn-icon">ğŸ“·</span>
              Selfie 2D
            </button>
            
            <button class="btn btn-primary btn-large btn-liveness" (click)="startLiveness3D()" [disabled]="livenessLoading">
              <span class="btn-icon">ğŸ”</span>
              <span *ngIf="livenessLoading">Carregando...</span>
              <span *ngIf="!livenessLoading">VerificaÃ§Ã£o 3D (Liveness)</span>
            </button>
          </div>
          
          <p class="liveness-hint">
            <strong>VerificaÃ§Ã£o 3D:</strong> Detecta movimento real e previne deepfakes
          </p>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Modal de Liveness 3D -->
  <div class="liveness-modal" *ngIf="showLivenessModal && livenessSession">
    <div class="modal-backdrop" (click)="closeLivenessModal()"></div>
    <div class="modal-content-liveness">
      <div class="modal-header-liveness">
        <h3>ğŸ” VerificaÃ§Ã£o 3D - Liveness Detection</h3>
        <button class="modal-close" (click)="closeLivenessModal()">âœ•</button>
      </div>
      
      <div class="liveness-instructions">
        <p><strong>InstruÃ§Ãµes:</strong></p>
        <ul>
          <li>Posicione seu rosto centralizado na tela</li>
          <li>Siga as instruÃ§Ãµes que aparecerem na tela</li>
          <li>Mova-se conforme solicitado (virar cabeÃ§a, piscar, etc.)</li>
          <li>ApÃ³s completar, clique em "Verificar Resultado"</li>
        </ul>
      </div>
      
      <div class="liveness-iframe-container">
        <iframe 
          *ngIf="safeStreamingUrl"
          [src]="safeStreamingUrl" 
          class="liveness-iframe"
          frameborder="0"
          allow="camera; microphone"
          (load)="onLivenessIframeLoad()">
        </iframe>
      </div>
      
      <div class="liveness-actions">
        <button class="btn btn-secondary" (click)="closeLivenessModal()">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="checkLivenessResult()" [disabled]="livenessLoading">
          <span *ngIf="livenessLoading">Verificando...</span>
          <span *ngIf="!livenessLoading">Verificar Resultado</span>
        </button>
      </div>
      
      <div class="liveness-error" *ngIf="livenessError">
        <p class="error-message">âŒ {{ livenessError }}</p>
      </div>
      
      <div class="liveness-result" *ngIf="livenessResult">
        <div class="result-info">
          <p><strong>Status:</strong> {{ livenessResult.status }}</p>
          <p><strong>DecisÃ£o:</strong> {{ livenessResult.livenessDecision }}</p>
          <p><strong>ConfianÃ§a:</strong> {{ (livenessResult.confidence * 100).toFixed(1) }}%</p>
          <p>{{ livenessResult.message }}</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal da CÃ¢mera -->
  <div class="camera-modal" *ngIf="showCameraModal">
    <div class="modal-content-fullscreen">
      <!-- BotÃ£o Cancel no topo -->
      <button class="modal-cancel" (click)="closeCameraModal()">
        Cancelar
      </button>
      
      <!-- Video da cÃ¢mera com mÃ¡scara -->
      <div class="camera-wrapper-fullscreen">
        <video #video autoplay playsinline muted class="camera-video-fullscreen"></video>
        
        <!-- MÃ¡scara escura ao redor (black overlay) -->
        <div class="camera-mask-overlay"></div>
        
        <!-- Overlay da cÃ¢mera -->
        <div class="camera-overlay-fullscreen" *ngIf="cameraReady">
          <!-- CÃ­rculo de captura -->
          <div class="capture-circle-fullscreen">
            <!-- Guias de alinhamento -->
            <div class="alignment-guide-fullscreen vertical-line"></div>
            <div class="alignment-guide-fullscreen horizontal-line"></div>
            
            <!-- Anel de progresso segmentado (verde) -->
            <div class="progress-ring-container">
              <svg class="progress-ring-fullscreen" viewBox="0 0 300 300">
                <circle class="progress-ring-circle"
                        cx="150" cy="150"
                        r="145"
                        fill="none"
                        stroke="#22c55e"
                        stroke-width="8"
                        [attr.stroke-dasharray]="progressDashArray"
                        [attr.stroke-dashoffset]="progressDashOffset"
                        stroke-linecap="round"
                        transform="rotate(-90 150 150)"/>
              </svg>
            </div>
          </div>
          
          <!-- BotÃ£o de captura -->
          <button class="capture-btn-fullscreen" 
                  (click)="captureSelfie()" 
                  [class.ready]="detectionStatus === 'ready'"
                  [class.disabled]="detectionStatus !== 'ready'">
            <div class="capture-btn-inner-fullscreen"></div>
          </button>
        </div>
        
        <!-- Overlay de loading -->
        <div class="overlay-loading" *ngIf="!cameraReady">
          <div class="overlay-content-loading">
            <span class="overlay-icon-loading">ğŸ“¹</span>
            <p>Iniciando cÃ¢mera...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SeÃ§Ã£o de Upload de Documento -->
  <section class="document-section">
    <div class="section-header">
      <h3 class="section-title">ğŸ“„ Documento (RG/CNH)</h3>
      <span class="section-subtitle">Frente do documento</span>
    </div>
    
    <div class="document-upload">
      <label for="docInput" class="upload-label">
        <div class="upload-box" [class.has-file]="documentPreview">
          <span class="upload-icon" *ngIf="!documentPreview">ğŸ“</span>
          <span class="upload-text" *ngIf="!documentPreview">
            Clique ou arraste para fazer upload
          </span>
          <input 
            id="docInput" 
            type="file" 
            accept="image/jpeg,image/png,image/webp" 
            (change)="onDocumentSelected($event)"
            class="file-input">
        </div>
      </label>
      
      <div class="document-preview" *ngIf="documentPreview">
        <div class="preview-label">PrÃ©-visualizaÃ§Ã£o do Documento</div>
        <img [src]="documentPreview" alt="Document preview">
      </div>
    </div>
  </section>

  <!-- BotÃ£o de ValidaÃ§Ã£o -->
  <div class="validation-actions">
    <button 
      class="btn btn-large btn-primary" 
      (click)="onUploadClick()" 
      [disabled]="!canValidate() || loading">
      <span class="btn-icon" *ngIf="!loading">{{ documentFile ? 'âœ…' : 'ğŸ“¤' }}</span>
      <span *ngIf="loading" class="spinner"></span>
      {{ loading ? 'Processandoâ€¦' : (documentFile ? 'Validar Selfie + Documento' : 'Enviar Selfie') }}
    </button>
  </div>

  <!-- Resultado da ValidaÃ§Ã£o -->
  <section class="result-section" *ngIf="result">
    <div class="result-card" [class.approved]="result.status==='Approved'" [class.rejected]="result.status==='Rejected'" [class.review]="result.status==='ManualReview'">
      <div class="result-header">
        <div class="result-status">
          <span class="status-icon">
            {{ result.status === 'Approved' ? 'âœ…' : result.status === 'Rejected' ? 'âŒ' : 'ğŸ”' }}
          </span>
          <div class="status-info">
            <h3 class="status-title">Status da ValidaÃ§Ã£o</h3>
            <span class="status-badge" [class.approved]="result.status==='Approved'" [class.rejected]="result.status==='Rejected'" [class.review]="result.status==='ManualReview'">
              {{ result.status === 'Approved' ? 'Aprovado' : result.status === 'Rejected' ? 'Rejeitado' : 'RevisÃ£o Manual' }}
            </span>
          </div>
        </div>
        <div class="result-score">
          <div class="score-value">{{ result.similarityScore | number:'1.1-1' }}%</div>
          <div class="score-label">Similaridade</div>
        </div>
      </div>
      
      <div class="result-message" *ngIf="result.message">
        <p>{{ result.message }}</p>
      </div>
      
      <div class="result-images" *ngIf="selfieViewUrl || documentViewUrl">
        <div class="image-item" *ngIf="selfieViewUrl">
          <div class="image-label">Selfie Enviada</div>
          <img [src]="selfieViewUrl" alt="Selfie from S3">
        </div>
        <div class="image-item" *ngIf="documentViewUrl">
          <div class="image-label">Documento Enviado</div>
          <img [src]="documentViewUrl" alt="Document from S3">
        </div>
      </div>
    </div>
  </section>

  <!-- Mensagens de Status -->
  <div class="status-messages" *ngIf="statusMessage">
    <div class="status-message">{{ statusMessage }}</div>
  </div>

  <div class="hint-info">
    <p>Formatos aceitos: JPEG, PNG ou WEBP (atÃ© 5MB)</p>
  </div>
</div>
