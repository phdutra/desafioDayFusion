<div class="history-page">
  <header class="history-header">
    <div>
      <h1>Hist√≥rico de Sess√µes</h1>
      <p>Acompanhe as verifica√ß√µes realizadas e acesse os artefatos armazenados no S3.</p>
    </div>
    <div class="history-actions">
      <button class="refresh" (click)="syncHistory()" [disabled]="syncingHistory()">
        üîÅ Sincronizar hist√≥rico
      </button>
      <button class="refresh" (click)="refreshSelected()" [disabled]="loadingMedia() || !selectedEntry()">
        üîÑ Atualizar URLs
      </button>
      <button class="clear" (click)="clearHistory()" [disabled]="!historyEntries().length">
        üóëÔ∏è Limpar hist√≥rico
      </button>
    </div>
  </header>

  <section class="history-content" *ngIf="historyEntries().length; else emptyState">
    <aside class="history-list">
      <article
        *ngFor="let entry of historyEntries(); trackBy: trackByEntry"
        class="history-item"
        [class.selected]="entry.id === selectedEntryId()"
        (click)="selectEntry(entry.id)"
      >
        <div class="item-header">
          <span class="status-badge" [class.approved]="entry.summary.status === 'Aprovado'" [class.rejected]="entry.summary.status === 'Rejeitado'">
            {{ entry.summary.status }}
          </span>
          <span class="item-date">{{ entry.createdAt | date: 'short' }}</span>
        </div>
        <div class="item-body">
          <p>Liveness: {{ entry.summary.livenessScore | number: '1.0-2' }}</p>
          <p>FaceMatch: {{ entry.summary.faceMatchScore ?? 'N/A' }}</p>
          <p>Capturas: {{ entry.summary.captures.length }}</p>
        </div>
      </article>
    </aside>

    <section class="history-details" *ngIf="selectedEntry() as entry">
      <div class="details-header">
        <div>
          <h2>Sess√£o {{ entry.sessionId }}</h2>
          <p>Executada em {{ entry.createdAt | date: 'fullDate' }} √†s {{ entry.createdAt | date: 'shortTime' }}</p>
        </div>
        <div class="info-tags">
          <span>Status: <strong>{{ entry.summary.status }}</strong></span>
          <span>Liveness: <strong>{{ entry.summary.livenessScore | number: '1.0-2' }}</strong></span>
          <span>FaceMatch: <strong>{{ entry.summary.faceMatchScore ?? 'N/A' }}</strong></span>
        </div>
      </div>

      <div *ngIf="loadError()" class="alert error">
        {{ loadError() }}
      </div>

      <div *ngIf="syncingHistory()" class="alert info">
        Sincronizando hist√≥rico com backend...
      </div>

      <div *ngIf="loadingMedia()" class="alert info">
        Atualizando URLs assinadas...
      </div>

      <div class="captures-section" *ngIf="entry.summary.captures.length; else noCaptures">
        <h3>Capturas</h3>
        <div class="captures-grid">
          <figure *ngFor="let capture of entry.summary.captures; trackBy: trackByCapture">
            <img [src]="getCaptureUrl(entry.id, capture)" [alt]="capture.position" loading="lazy" />
            <figcaption>
              <div class="capture-meta">
                <strong>{{ capture.position }}</strong>
                <span>Confian√ßa {{ capture.confidence | number: '1.0-2' }}%</span>
              </div>
              <button class="open-button" (click)="openCapture(entry, capture, $event)">Abrir no S3</button>
              <code class="key">{{ capture.s3Key }}</code>
            </figcaption>
          </figure>
        </div>
      </div>

      <ng-template #noCaptures>
        <div class="alert warn">
          Nenhuma captura registrada para esta sess√£o.
        </div>
      </ng-template>

      <div class="document-section" *ngIf="entry.summary.documentKey">
        <h3>Documento</h3>
        <div class="document-card">
          <div class="document-preview">
            <img [src]="getDocumentUrl(entry.id)" alt="Documento" loading="lazy" />
          </div>
          <div class="document-meta">
            <span class="document-label">Chave S3</span>
            <code>{{ entry.summary.documentKey }}</code>
            <button class="open-button" (click)="openDocument(entry, $event)">Abrir no S3</button>
          </div>
        </div>
      </div>

      <div class="video-section" *ngIf="entry.summary.video">
        <h3>V√≠deo da Sess√£o</h3>
        <video controls [src]="getVideoUrl(entry.id, entry.summary.video)" preload="metadata"></video>
        <div class="video-meta">
          <span>{{ entry.summary.video.mimeType }}</span>
          <span>{{ entry.summary.video.size / (1024 * 1024) | number: '1.1-1' }} MB</span>
          <span>{{ entry.summary.video.durationMs / 1000 | number: '1.0-1' }} s</span>
        </div>
        <div class="video-actions">
          <button class="open-button" (click)="openVideo(entry, $event)">Abrir no S3</button>
          <code class="key">{{ entry.summary.video.s3Key }}</code>
        </div>
      </div>
    </section>
  </section>
</div>

<ng-template #emptyState>
  <div class="empty-state">
    <h2>Nenhuma sess√£o registrada ainda</h2>
    <p>Realize a primeira verifica√ß√£o na tela de Dashboard. As sess√µes conclu√≠das aparecer√£o aqui automaticamente.</p>
  </div>
</ng-template>


