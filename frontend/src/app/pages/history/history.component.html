<div class="history-page">
  <header class="history-header">
    <div>
      <h1>Hist√≥rico de Sess√µes</h1>
      <p>Acompanhe as verifica√ß√µes realizadas e acesse os artefatos armazenados no S3.</p>
    </div>
    <div class="history-actions">
      <button class="refresh" (click)="syncHistory()" [disabled]="syncingHistory()">
        üîÅ Sincronizar hist√≥rico
      </button>
      <button class="refresh" (click)="refreshSelected()" [disabled]="loadingMedia() || !selectedEntry()">
        üîÑ Atualizar URLs
      </button>
      <button class="clear" (click)="openClearConfirmModal()" [disabled]="!historyEntries().length">
        üóëÔ∏è Limpar hist√≥rico
      </button>
    </div>
  </header>

  <section class="history-content" *ngIf="historyEntries().length; else emptyState">
    <aside class="history-list">
      <article
        *ngFor="let entry of historyEntries(); trackBy: trackByEntry"
        class="history-item"
        [class.selected]="entry.id === selectedEntryId()"
        (click)="selectEntry(entry.id)"
      >
        <div class="item-header">
          <span class="status-badge" [class.approved]="entry.summary.status === 'Aprovado'" [class.rejected]="entry.summary.status === 'Rejeitado'">
            {{ entry.summary.status }}
          </span>
          <span class="item-date">{{ entry.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
        </div>
        <div class="item-body">
          <p>Liveness: {{ entry.summary.livenessScore | number: '1.0-2' }}</p>
          <p>FaceMatch: {{ entry.summary.faceMatchScore ?? 'N/A' }}</p>
          <p [class.document-invalid-text]="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey"
             [class.document-approved-text]="entry.summary.status === 'Aprovado' && entry.summary.documentKey">
            Documento: 
            <ng-container *ngIf="entry.summary.status === 'Aprovado' && entry.summary.documentKey">
              V√°lido
            </ng-container>
            <ng-container *ngIf="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey">
              Inv√°lido
            </ng-container>
            <span *ngIf="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey" class="invalid-indicator">‚ö†Ô∏è</span>
          </p>
          <p>Capturas: {{ entry.summary.captures.length }}</p>
        </div>
      </article>
    </aside>

    <section class="history-details" *ngIf="selectedEntry() as entry">
      <div class="details-header">
        <div>
          <h2>Detalhes da Sess√£o</h2>
          <p>{{ entry.createdAt | date: 'dd/MM/yyyy' }} √†s {{ entry.createdAt | date: 'HH:mm' }}</p>
        </div>
        <div class="info-tags">
          <span>Status: <strong>{{ entry.summary.status }}</strong></span>
          <span>Liveness: <strong>{{ entry.summary.livenessScore | number: '1.0-2' }}</strong></span>
          <span>FaceMatch: <strong>{{ entry.summary.faceMatchScore ?? 'N/A' }}</strong></span>
          <span [class.document-invalid]="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey"
                [class.document-valid]="entry.summary.status === 'Aprovado' && entry.summary.documentKey">
            Documento: <strong>
              <ng-container *ngIf="entry.summary.status === 'Aprovado' && entry.summary.documentKey">
                <span *ngIf="entry.summary.status === 'Aprovado' && entry.summary.documentKey" class="valid-badge">V√°lido</span>
                
              </ng-container>
              <ng-container *ngIf="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey">
                <span *ngIf="entry.summary.status !== 'Aprovado' || !entry.summary.documentKey" class="invalid-badge">Inv√°lido</span>
              </ng-container>
            </strong>
            
          </span>
        </div>
      </div>

      <div *ngIf="loadError()" class="alert error">
        {{ loadError() }}
      </div>

      <div *ngIf="syncingHistory()" class="alert info">
        Sincronizando hist√≥rico com backend...
      </div>

      <div *ngIf="loadingMedia()" class="alert info">
        Atualizando URLs assinadas...
      </div>

      <!-- An√°lise da Sess√£o / Motivo da Rejei√ß√£o -->
      <div class="analysis-section" *ngIf="getObservacao(entry)">
        <h3>üìã An√°lise da Sess√£o</h3>
        <div class="analysis-content" 
             [class.analysis-rejected]="entry.summary.status === 'Rejeitado'"
             [class.analysis-approved]="entry.summary.status === 'Aprovado'">
          <p>{{ getObservacao(entry) }}</p>
        </div>
      </div>

      <div class="captures-section" *ngIf="entry.summary.captures.length; else noCaptures">
        <h3>Capturas</h3>
        <div class="carousel-container">
          <button class="carousel-nav prev" (click)="prevCapture(entry)" [disabled]="entry.summary.captures.length <= 1">
            ‚Äπ
          </button>
          
          <div class="carousel-track">
            <figure 
              *ngFor="let capture of entry.summary.captures; let i = index; trackBy: trackByCapture"
              class="carousel-item"
              [class.active]="i === currentCaptureIndex()"
              (click)="openCaptureImage(entry, capture, $event)">
              <img [src]="getCaptureUrl(entry.id, capture)" [alt]="capture.position" loading="lazy" />
              <figcaption>
                <div class="capture-meta">
                  <strong>{{ capture.position }}</strong>
                  <span>Confian√ßa {{ capture.confidence | number: '1.0-2' }}%</span>
                </div>
                <code class="key">{{ capture.s3Key }}</code>
              </figcaption>
            </figure>
          </div>
          
          <button class="carousel-nav next" (click)="nextCapture(entry)" [disabled]="entry.summary.captures.length <= 1">
            ‚Ä∫
          </button>
        </div>
        
        <div class="carousel-indicators" *ngIf="entry.summary.captures.length > 1">
          <span 
            *ngFor="let capture of entry.summary.captures; let i = index"
            class="indicator"
            [class.active]="i === currentCaptureIndex()"
            (click)="currentCaptureIndex.set(i)">
          </span>
        </div>
      </div>

      <ng-template #noCaptures>
        <div class="alert warn">
          Nenhuma captura registrada para esta sess√£o.
        </div>
      </ng-template>

      <div class="document-section" *ngIf="entry.summary.documentKey">
        <h3>Documento</h3>
        <div class="document-card" (click)="openDocument(entry, $event)">
          <div class="document-preview">
            <img [src]="getDocumentUrl(entry.id)" alt="Documento" loading="lazy" />
          </div>
          <div class="document-meta">
            <span class="document-label">Chave S3</span>
            <code>{{ entry.summary.documentKey }}</code>
          </div>
        </div>
      </div>

      <div class="video-section" *ngIf="entry.summary.video">
        <h3>V√≠deo da Sess√£o</h3>
        <video controls [src]="getVideoUrl(entry.id, entry.summary.video)" preload="metadata"></video>
        <div class="video-meta">
          <span>{{ entry.summary.video.mimeType }}</span>
          <span>{{ entry.summary.video.size / (1024 * 1024) | number: '1.1-1' }} MB</span>
          <span>{{ entry.summary.video.durationMs / 1000 | number: '1.0-1' }} s</span>
        </div>
        <div class="video-actions">
          <button class="open-button" (click)="openVideo(entry, $event)">Abrir no S3</button>
          <code class="key">{{ entry.summary.video.s3Key }}</code>
        </div>
      </div>
    </section>
  </section>
</div>

<ng-template #emptyState>
  <div class="empty-state">
    <h2>Nenhuma sess√£o registrada ainda</h2>
    <p>Realize a primeira verifica√ß√£o na tela de Dashboard. As sess√µes conclu√≠das aparecer√£o aqui automaticamente.</p>
  </div>
</ng-template>

<!-- Modal de Confirma√ß√£o para Limpar Hist√≥rico -->
<div class="modal-overlay" *ngIf="showClearConfirmModal()" (click)="closeClearConfirmModal()">
  <div class="confirm-modal" (click)="$event.stopPropagation()">
    <div class="modal-icon warning">‚ö†Ô∏è</div>
    <h3>Confirmar Limpeza de Hist√≥rico</h3>
    <p>Tem certeza que deseja limpar o hist√≥rico?</p>
    <p class="warning-text">Todas as sess√µes locais ser√£o removidas permanentemente.</p>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeClearConfirmModal()">
        Cancelar
      </button>
      <button class="btn-confirm" (click)="confirmClearHistory()">
        Sim, limpar tudo
      </button>
    </div>
  </div>
</div>

<!-- Modal de Visualiza√ß√£o de Imagem -->
<div class="modal-overlay" *ngIf="showImageModal()" (click)="closeImageModal()" (mousedown)="$event.stopPropagation()">
  <div class="image-modal" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
    <div class="image-modal-header">
      <h3>{{ modalImageTitle() }}</h3>
      <div class="header-actions">
        <span class="zoom-hint">üîç Clique na imagem para zoom</span>
        <button class="close-button" (click)="closeImageModal()">‚úï</button>
      </div>
    </div>
    <div class="image-modal-body" [class.zoomed]="isImageZoomed()">
      <img 
        [src]="modalImageUrl()" 
        [alt]="modalImageTitle()" 
        class="zoomable-image"
        [class.zoomed]="isImageZoomed()"
        (click)="onImageClick($event)"
      />
    </div>
    <div class="image-modal-footer">
      <button class="btn-download" (click)="downloadImage()">
        üì• Abrir no S3
      </button>
      <button class="btn-close" (click)="closeImageModal()">
        Fechar
      </button>
    </div>
  </div>
</div>


