<div class="history-container fade-in-up">
  <div class="history-header">
    <h2 class="gradient-text page-title">ğŸ“‹ HistÃ³rico de ValidaÃ§Ãµes</h2>
    <p class="page-subtitle">Visualize todas as comparaÃ§Ãµes faciais realizadas com seus respectivos scores</p>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner-large"></div>
    <p>Carregando histÃ³rico...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && transactions.length === 0">
    <div class="empty-icon">ğŸ“­</div>
    <h3>Nenhuma transaÃ§Ã£o encontrada</h3>
    <p>Quando vocÃª realizar validaÃ§Ãµes faciais, elas aparecerÃ£o aqui.</p>
  </div>

  <!-- Transactions List -->
  <div class="transactions-list" *ngIf="!loading && transactions.length">
    <div class="transaction-card" *ngFor="let tx of transactions" (click)="openResult(tx.id)">
      <div class="transaction-images">
        <div class="image-thumb" *ngIf="thumbs[tx.id]?.selfie">
          <div class="image-label">Selfie</div>
          <img [src]="thumbs[tx.id]!.selfie!" alt="Selfie">
        </div>
        <div class="image-thumb" *ngIf="thumbs[tx.id]?.doc">
          <div class="image-label">Documento</div>
          <img [src]="thumbs[tx.id]!.doc!" alt="Documento">
        </div>
        <div class="no-images" *ngIf="!thumbs[tx.id]?.selfie && !thumbs[tx.id]?.doc">
          <span class="no-images-icon">ğŸ–¼ï¸</span>
          <span class="no-images-text">Imagens nÃ£o disponÃ­veis</span>
        </div>
      </div>

      <div class="transaction-info">
        <div class="transaction-header">
          <div class="transaction-id">
            <span class="id-label">ID:</span>
            <span class="id-value">{{ tx.id }}</span>
          </div>
          <div class="transaction-date">
            <span class="date-icon">ğŸ“…</span>
            <span>{{ tx.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>

        <div class="transaction-status-score">
          <div class="status-badge" 
               [class.approved]="tx.status === 'Approved'" 
               [class.rejected]="tx.status === 'Rejected'" 
               [class.review]="tx.status === 'ManualReview'"
               [class.pending]="tx.status === 'Pending'"
               [class.processing]="tx.status === 'Processing'"
               [class.error]="tx.status === 'Error'">
            <span class="status-icon">
              {{ tx.status === 'Approved' ? 'âœ…' : 
                 tx.status === 'Rejected' ? 'âŒ' : 
                 tx.status === 'ManualReview' ? 'ğŸ”' : 
                 tx.status === 'Pending' ? 'â³' :
                 tx.status === 'Processing' ? 'âš™ï¸' : 'âš ï¸' }}
            </span>
            <span class="status-text">
              {{ tx.status === 'Approved' ? 'Aprovado' : 
                 tx.status === 'Rejected' ? 'Rejeitado' : 
                 tx.status === 'ManualReview' ? 'RevisÃ£o Manual' : 
                 tx.status === 'Pending' ? 'Pendente' :
                 tx.status === 'Processing' ? 'Processando' : 'Erro' }}
            </span>
          </div>

          <!-- Score Principal: IdentityScore ou SimilarityScore -->
          <div class="score-display" *ngIf="tx.identityScore !== null && tx.identityScore !== undefined">
            <div class="score-value">{{ (tx.identityScore * 100) | number:'1.1-1' }}%</div>
            <div class="score-label">Score Final (Identity)</div>
            <div class="score-bar">
              <div class="score-bar-fill" 
                   [style.width.%]="tx.identityScore * 100" 
                   [class.score-high]="tx.identityScore >= 0.85"
                   [class.score-medium]="tx.identityScore >= 0.70 && tx.identityScore < 0.85"
                   [class.score-low]="tx.identityScore < 0.70">
              </div>
            </div>
          </div>
          <div class="score-display" *ngIf="(tx.identityScore === null || tx.identityScore === undefined) && tx.similarityScore !== null && tx.similarityScore !== undefined">
            <div class="score-value">{{ tx.similarityScore | number:'1.1-1' }}%</div>
            <div class="score-label">Similaridade</div>
            <div class="score-bar">
              <div class="score-bar-fill" 
                   [style.width.%]="tx.similarityScore" 
                   [class.score-high]="tx.similarityScore >= 80"
                   [class.score-medium]="tx.similarityScore >= 60 && tx.similarityScore < 80"
                   [class.score-low]="tx.similarityScore < 60">
              </div>
            </div>
          </div>
          <div class="score-display no-score" *ngIf="(tx.identityScore === null || tx.identityScore === undefined) && (tx.similarityScore === null || tx.similarityScore === undefined)">
            <div class="score-value">N/A</div>
            <div class="score-label">Score nÃ£o disponÃ­vel</div>
          </div>
        </div>

        <!-- Scores Detalhados -->
        <div class="scores-detail" *ngIf="tx.identityScore !== null || tx.documentScore !== null || tx.livenessScore !== null">
          <div class="scores-grid">
            <div class="score-item" *ngIf="tx.livenessScore !== null && tx.livenessScore !== undefined">
              <div class="score-item-label">Liveness</div>
              <div class="score-item-value">{{ tx.livenessScore | number:'1.1-1' }}%</div>
            </div>
            <div class="score-item" *ngIf="tx.similarityScore !== null && tx.similarityScore !== undefined">
              <div class="score-item-label">Match</div>
              <div class="score-item-value">{{ tx.similarityScore | number:'1.1-1' }}%</div>
            </div>
            <div class="score-item" *ngIf="tx.documentScore !== null && tx.documentScore !== undefined">
              <div class="score-item-label">Documento</div>
              <div class="score-item-value">{{ tx.documentScore | number:'1.1-1' }}%</div>
            </div>
          </div>
        </div>

        <!-- ObservaÃ§Ã£o AutomÃ¡tica -->
        <div class="transaction-observacao" *ngIf="tx.observacao">
          <div class="observacao-label">ğŸ“‹ AnÃ¡lise AutomÃ¡tica:</div>
          <div class="observacao-text" 
               [class.observacao-high]="tx.identityScore !== null && tx.identityScore >= 0.85"
               [class.observacao-medium]="tx.identityScore !== null && tx.identityScore >= 0.70 && tx.identityScore < 0.85"
               [class.observacao-low]="tx.identityScore !== null && tx.identityScore < 0.70">
            {{ tx.observacao }}
          </div>
        </div>

        <div class="transaction-notes" *ngIf="tx.reviewNotes || tx.rejectionReason">
          <div class="notes-label">ObservaÃ§Ãµes Manuais:</div>
          <div class="notes-text">{{ tx.reviewNotes || tx.rejectionReason }}</div>
        </div>

        <div class="transaction-footer">
          <button class="view-btn" (click)="openResult(tx.id); $event.stopPropagation()">
            <span class="btn-icon">ğŸ‘ï¸</span>
            Ver Detalhes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary-card" *ngIf="!loading && transactions.length">
    <div class="summary-item">
      <div class="summary-value">{{ transactions.length }}</div>
      <div class="summary-label">Total de ValidaÃ§Ãµes</div>
    </div>
    <div class="summary-item">
      <div class="summary-value">{{ getApprovedCount() }}</div>
      <div class="summary-label">Aprovadas</div>
    </div>
    <div class="summary-item">
      <div class="summary-value">{{ getAverageScore() | number:'1.1-1' }}%</div>
      <div class="summary-label">Score MÃ©dio</div>
    </div>
  </div>
</div>
