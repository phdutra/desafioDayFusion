<div class="modal-overlay" *ngIf="isModalOpen()" (click)="closeModal()">
  <div class="modal-wrapper" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeModal()" aria-label="Fechar modal">âœ•</button>

    <div *ngIf="showPreparationScreen()" class="preparation-screen" (click)="$event.stopPropagation()">
      <div class="preparation-content">
        <div class="preparation-icon">ğŸ’¡</div>
        <h2 class="preparation-title">Prepare-se para a VerificaÃ§Ã£o</h2>
        <p class="preparation-subtitle">Siga estas instruÃ§Ãµes para garantir o melhor resultado:</p>

        <div class="preparation-instructions">
          <div class="instruction-item">
            <div class="instruction-icon">ğŸ’¡</div>
            <div class="instruction-text">
              <strong>Ligue a luz frontal</strong>
              <p>Garanta iluminaÃ§Ã£o adequada (mÃ­nimo 500 lux) para melhor detecÃ§Ã£o</p>
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-icon">ğŸš«</div>
            <div class="instruction-text">
              <strong>Evite ficar contra a luz</strong>
              <p>NÃ£o fique de costas para janelas ou fontes de luz intensa</p>
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-icon">ğŸ“</div>
            <div class="instruction-text">
              <strong>Mantenha distÃ¢ncia adequada</strong>
              <p>Fique a 40-70 cm da cÃ¢mera para melhor captura</p>
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-icon">ğŸ‘¤</div>
            <div class="instruction-text">
              <strong>Centralize o rosto</strong>
              <p>Mantenha o rosto totalmente visÃ­vel e centralizado no cÃ­rculo</p>
            </div>
          </div>
        </div>

        <div class="preparation-actions">
          <div class="preparation-countdown">
            <div class="countdown-circle">
              <span class="countdown-number">{{ preparationCountdown() }}</span>
            </div>
            <p class="preparation-auto-start">A verificaÃ§Ã£o iniciarÃ¡ automaticamente...</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!showReviewStep() && !showPreparationScreen()" class="widget-container">
      <div class="countdown-overlay" *ngIf="showCountdown()">
        <div class="countdown-content">
          <div class="countdown-number" [attr.data-number]="countdown()">{{ countdown() }}</div>
          <p>Preparando verificaÃ§Ã£o...</p>
        </div>
      </div>

      <div class="photosensitivity-tooltip" *ngIf="!showCountdown() && !errorMessageSignal()">
        <div class="tooltip-icon" title="Aviso de fotossensibilidade">â„¹ï¸</div>
        <div class="tooltip-content">
          <strong>Aviso de fotossensibilidade</strong>
          <p>Este teste de liveness usa luz estroboscÃ³pica que pode afetar pessoas com epilepsia fotossensÃ­vel.</p>
        </div>
      </div>

      <div class="dayfusion-modal">
        <div class="aws-widget-wrapper">
          <div id="liveness-container-official" [class.countdown-active]="showCountdown()"></div>
        </div>
      </div>

      <div class="status-message" *ngIf="statusMessage() && !errorMessageSignal() && !showCountdown()">
        <p>
          <span *ngIf="isVerifying()" class="verifying-spinner-custom"></span>
          {{ statusMessage() }}
        </p>
      </div>

      <div class="verifying-loading-overlay" *ngIf="isVerifying() && !errorMessageSignal() && !showCountdown()">
        <div class="verifying-loading-content">
          <div class="verifying-spinner-large"></div>
          <p>Verificando...</p>
        </div>
      </div>

      <div class="recording-indicator" *ngIf="isRecordingVideo()">
        <div class="recording-dot"></div>
        <span>ğŸ¥ Gravando vÃ­deo...</span>
      </div>

      <div class="error-message" *ngIf="errorMessageSignal()">
        <p>{{ errorMessageSignal() }}</p>
      </div>

      <div class="loading-spinner" *ngIf="isLoading() && !errorMessageSignal() && !showCountdown()">
        <div class="spinner"></div>
        <p>Aguardando widget carregar...</p>
      </div>
    </div>

    <div *ngIf="showReviewStep() && livenessResult() && documentS3PathSignal?.()" class="review-container">
      <app-custom-review-step
        [livenessResult]="livenessResult()!"
        [documentImageS3Path]="documentS3PathSignal()!"
        [documentImageUrl]="documentUrlSignal() || undefined"
        (finished)="handleReviewFinished($event)">
      </app-custom-review-step>
    </div>
  </div>
</div>
