<div class="capture-official-page fade-in-up">
  <section class="intro-card">
    <div class="intro-icon">üõ°Ô∏è</div>
    <div class="intro-content">
      <h2 class="intro-title gradient-text">Captura Oficial</h2>
      <p class="intro-description">
        Verifica√ß√£o facial completa usando o Widget AWS Face Liveness oficial.
        Captura 100% do widget AWS com match autom√°tico com documento.
      </p>
      <ul class="intro-benefits">
        <li>‚úÖ Widget AWS oficial (100% captura do widget)</li>
        <li>‚úÖ Match autom√°tico com documento</li>
        <li>‚úÖ An√°lise completa de liveness e identidade</li>
      </ul>
    </div>
    <div class="intro-actions">
      <button class="btn-dashboard" (click)="openModal()" 
              [disabled]="!documentFile() || isUploadingDocument() || isDocumentValid() === false">
        <span class="btn-icon" *ngIf="!isUploadingDocument()">‚ñ∂</span>
        <span class="btn-loading-spinner" *ngIf="isUploadingDocument()"></span>
        <span>
          <span *ngIf="isUploadingDocument()">Enviando documento...</span>
          <span *ngIf="!isUploadingDocument() && isDocumentValid() === false">Documento inv√°lido</span>
          <span *ngIf="!isUploadingDocument() && (isDocumentValid() === true || isDocumentValid() === null)">Iniciar Verifica√ß√£o Oficial</span>
        </span>
      </button>
      <p class="intro-hint">Necess√°rio navegador com HTTPS e permiss√£o de c√¢mera.</p>
    </div>
  </section>

  <!-- 1Ô∏è‚É£ PRIMEIRO: Documento de Refer√™ncia -->
  <section class="document-upload-card">
    <div class="document-content">
      <div class="step-badge">
        <span class="step-number">1</span>
        <h3>Documento de Refer√™ncia</h3>
      </div>
      <p>Primeiro, fa√ßa upload de um documento (RG/CNH) para compara√ß√£o facial.</p>
      <div class="document-input">
        <label class="upload-button">
          <input type="file" accept="image/*" (change)="onDocumentSelected($event)" hidden [disabled]="isLoading()" />
          <span>üìÑ Selecionar documento</span>
        </label>
        <div class="document-info" *ngIf="documentInfo() as info; else noDocument">
          <div>
            <strong>{{ info.name }}</strong>
            <p>{{ info.sizeKb | number:'1.0-0' }} KB</p>
          </div>
          <button class="btn-ghost" type="button" (click)="clearDocument()" [disabled]="isLoading()">Remover</button>
        </div>
        <ng-template #noDocument>
          <p class="document-placeholder">Nenhum documento selecionado.</p>
        </ng-template>
        <!-- Informa√ß√£o de compress√£o -->
        <div class="compression-info" *ngIf="compressionInfo() as compInfo">
          <div class="compression-badge">
            <span>üì¶</span>
            <span>Comprimido: {{ compInfo.original }} KB ‚Üí {{ compInfo.compressed }} KB ({{ compInfo.reduction }}% menor)</span>
          </div>
        </div>
        <!-- Mensagem de valida√ß√£o do documento - S√≥ mostrar se documento for INV√ÅLIDO -->
        <div class="document-validation-message" *ngIf="documentValidationMessage() && isDocumentValid() === false">
          <div [ngClass]="{
            'validation-badge': true,
            'invalid': true
          }">
            <span>‚ùå</span>
            {{ documentValidationMessage() }}
          </div>
          <div *ngIf="documentScore() !== null" class="document-score">
            Score: {{ documentScore() | number:'1.0-0' }}%
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Resultado -->
  <section class="result-section" *ngIf="statusSummary() as summary">
    <div class="result-card" 
         [class.approved]="summary.status === 'Aprovado'" 
         [class.rejected]="summary.status === 'Rejeitado'" 
         [class.review]="summary.status === 'Revisar'">
      <div class="result-header">
        <div class="result-status">
          <span class="status-icon">
            {{ summary.status === 'Aprovado' ? '‚úÖ' : summary.status === 'Rejeitado' ? '‚ùå' : 'üîç' }}
          </span>
          <div>
            <h4>Status: {{ summary.status }}</h4>
            <p>Sess√£o {{ summary.sessionId }}</p>
          </div>
        </div>
        <div class="result-score">
          <div>
            <span class="score-label">Score Liveness</span>
            <span class="score-value">{{ summary.livenessScore | number:'1.0-0' }}%</span>
          </div>
          <div>
            <span class="score-label">Match Documento</span>
            <span class="score-value">{{ summary.faceMatchScore !== null ? (summary.faceMatchScore | number:'1.0-0') + '%' : 'N/A' }}</span>
          </div>
        </div>
      </div>
      <div class="result-actions" *ngIf="summary.status === 'Rejeitado'">
        <button class="btn-history" (click)="goToHistory()">
          üìã Ver no Hist√≥rico
        </button>
      </div>
    </div>
  </section>

  <div class="status-banner error" *ngIf="errorMessage()">
    <span>‚ö†Ô∏è {{ errorMessage() }}</span>
  </div>

  <!-- Modal de Captura -->
  <div class="modal-overlay" *ngIf="isModalOpen()" (click)="closeModal()">
    <div class="modal-wrapper" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeModal()" aria-label="Fechar modal">‚úï</button>
      
      <!-- Etapa 1: Widget AWS -->
      <div *ngIf="!showReviewStep()" class="widget-container">
        <!-- Contagem Regressiva -->
        <div class="countdown-overlay" *ngIf="showCountdown()">
          <div class="countdown-content">
            <div class="countdown-number">{{ countdown() }}</div>
            <p>Preparando verifica√ß√£o...</p>
          </div>
        </div>

        <!-- Tooltip de Aviso de Fotossensibilidade -->
        <div class="photosensitivity-tooltip" *ngIf="!showCountdown() && !errorMessage()">
          <div class="tooltip-icon" title="Aviso de fotossensibilidade">‚ÑπÔ∏è</div>
          <div class="tooltip-content">
            <strong>Aviso de fotossensibilidade</strong>
            <p>Este teste de liveness usa luz estrobosc√≥pica que pode afetar pessoas com epilepsia fotossens√≠vel.</p>
          </div>
        </div>

        <div id="liveness-container-official" 
             [class.countdown-active]="showCountdown()"
             style="margin-top: -3rem; transform: translateY(-30px);">
        </div>
        
        <div class="status-message" *ngIf="statusMessage() && !errorMessage() && !showCountdown()">
          <p>
            <span *ngIf="isVerifying()" class="verifying-spinner-custom"></span>
            {{ statusMessage() }}
          </p>
        </div>
        
        <!-- Loading customizado quando "Verifying..." -->
        <div class="verifying-loading-overlay" *ngIf="isVerifying() && !errorMessage() && !showCountdown()">
          <div class="verifying-loading-content">
            <div class="verifying-spinner-large"></div>
            <p>Verificando...</p>
          </div>
        </div>
        
        <!-- Indicador de grava√ß√£o de v√≠deo -->
        <div class="recording-indicator" *ngIf="isRecordingVideo()">
          <div class="recording-dot"></div>
          <span>üé• Gravando v√≠deo...</span>
        </div>
        <div class="error-message" *ngIf="errorMessage()">
          <p>{{ errorMessage() }}</p>
        </div>
        <div class="loading-spinner" *ngIf="isLoading() && !errorMessage() && !showCountdown()">
          <div class="spinner"></div>
          <p>Aguardando widget carregar...</p>
        </div>
      </div>

      <!-- Etapa 2: Review com Match -->
      <div *ngIf="showReviewStep() && livenessResult() && documentS3Path()" class="review-container">
        <app-custom-review-step
          [livenessResult]="livenessResult()!"
          [documentImageS3Path]="documentS3Path()!"
          [documentImageUrl]="documentUrl() || undefined"
          (finished)="handleReviewFinished($event)">
        </app-custom-review-step>
      </div>
    </div>
  </div>
</div>

