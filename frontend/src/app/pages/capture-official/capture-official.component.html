<div class="capture-official-page fade-in-up">
  <section class="intro-card">
    <div class="intro-icon">üõ°Ô∏è</div>
    <div class="intro-content">
      <h2 class="intro-title gradient-text">Captura Oficial</h2>
      <p class="intro-description">
        Verifica√ß√£o facial completa usando o Widget AWS Face Liveness oficial.
        Captura 100% do widget AWS com match autom√°tico com documento.
      </p>
      <ul class="intro-benefits">
        <li>‚úÖ Widget AWS oficial (100% captura do widget)</li>
        <li>‚úÖ Match autom√°tico com documento</li>
        <li>‚úÖ An√°lise completa de liveness e identidade</li>
      </ul>
    </div>
    <div class="intro-actions">
      <button class="btn-dashboard" (click)="startLivenessVerification()" 
              [disabled]="isUploadingDocument() || (documentFile() && isDocumentValid() === false)">
        <span class="btn-icon" *ngIf="!isUploadingDocument()">‚ñ∂</span>
        <span class="btn-loading-spinner" *ngIf="isUploadingDocument()"></span>
        <span>
          <span *ngIf="isUploadingDocument()">Enviando documento...</span>
          <span *ngIf="!isUploadingDocument() && documentFile() && isDocumentValid() === false">Documento inv√°lido</span>
          <span *ngIf="!isUploadingDocument() && (!documentFile() || isDocumentValid() !== false)">Iniciar Verifica√ß√£o Oficial</span>
        </span>
      </button>
      <p class="intro-hint">Necess√°rio navegador com HTTPS e permiss√£o de c√¢mera.</p>
    </div>
  </section>

  <!-- 1Ô∏è‚É£ PRIMEIRO: Documento de Refer√™ncia -->
  <section class="document-upload-card">
    <div class="document-content">
      <div class="step-badge">
        <span class="step-number">1</span>
        <h3>Documento de Refer√™ncia</h3>
      </div>
      <p>Primeiro, fa√ßa upload de um documento (RG/CNH) para compara√ß√£o facial.</p>
      <div class="document-input">
        <label class="upload-button">
          <input type="file" accept="image/*" (change)="onDocumentSelected($event)" hidden [disabled]="isUploadingDocument()" />
          <span>üìÑ Selecionar documento</span>
        </label>
        <div class="document-info" *ngIf="documentInfo() as info; else noDocument">
          <div>
            <strong>{{ info.name }}</strong>
            <p>{{ info.sizeKb | number:'1.0-0' }} KB</p>
          </div>
          <button class="btn-ghost" type="button" (click)="clearDocument()" [disabled]="isUploadingDocument()">Remover</button>
        </div>
        <ng-template #noDocument>
          <p class="document-placeholder">Nenhum documento selecionado.</p>
        </ng-template>
        <!-- Informa√ß√£o de compress√£o -->
        <div class="compression-info" *ngIf="compressionInfo() as compInfo">
          <div class="compression-badge">
            <span>üì¶</span>
            <span>Comprimido: {{ compInfo.original }} KB ‚Üí {{ compInfo.compressed }} KB ({{ compInfo.reduction }}% menor)</span>
          </div>
        </div>
        <!-- Mensagem de valida√ß√£o do documento - S√≥ mostrar se documento for INV√ÅLIDO -->
        <div class="document-validation-message" *ngIf="documentValidationMessage() && isDocumentValid() === false">
          <div [ngClass]="{
            'validation-badge': true,
            'invalid': true
          }">
            <span>‚ùå</span>
            {{ documentValidationMessage() }}
          </div>
          <div *ngIf="documentScore() !== null" class="document-score">
            Score: {{ documentScore() | number:'1.0-0' }}%
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Resultado -->
  <section class="result-section fade-in-up" *ngIf="lastSummary() as summary">
    <div class="result-card" 
         [class.approved]="summary.status === 'Aprovado'" 
         [class.rejected]="summary.status === 'Rejeitado'" 
         [class.review]="summary.status === 'Revisar'">
      <div class="result-header">
        <div class="result-status">
          <span class="status-icon">
            {{ summary.status === 'Aprovado' ? '‚úÖ' : summary.status === 'Rejeitado' ? '‚ùå' : 'üîç' }}
          </span>
          <div>
            <h4>Status: {{ summary.status }}</h4>
            <p>Sess√£o {{ summary.sessionId }}</p>
          </div>
        </div>
        <div class="result-score">
          <div>
            <span class="score-label">Score Liveness</span>
            <span class="score-value">{{ summary.livenessScore | number:'1.0-0' }}%</span>
          </div>
          <div>
            <span class="score-label">Match Documento</span>
            <span class="score-value">{{ summary.faceMatchScore !== null && summary.faceMatchScore !== undefined ? (summary.faceMatchScore | number:'1.0-0') + '%' : 'N/A' }}</span>
          </div>
        </div>
      </div>

      <!-- Thumbs e Documento -->
      <div class="result-images-section" *ngIf="summary.captures?.length || documentUrl()">
        <div class="result-thumbs" *ngIf="summary.captures?.length">
          <h4>Imagens de Liveness</h4>
          <div class="thumbs-grid">
            <div class="thumb-item" *ngFor="let capture of summary.captures">
              <div class="thumb-label">Captura {{ capture.position }}</div>
              <img [src]="capture.previewUrl || ('/api/media/liveness-frame?bucket=dayfusion-docs&key=' + capture.s3Key)" 
                   [alt]="'Captura ' + capture.position"
                   class="thumb-image"
                   (error)="onThumbImageError($event, capture.s3Key)" />
              <span class="thumb-meta">Confian√ßa {{ capture.confidence | number:'1.0-0' }}%</span>
            </div>
          </div>
        </div>

        <div class="result-document" *ngIf="documentUrl()">
          <h4>Documento</h4>
          <div class="document-image-wrapper">
            <img [src]="documentUrl()!" 
                 alt="Documento"
                 class="document-image"
                 (error)="onDocumentImageError($event)" />
          </div>
        </div>
      </div>

      <div class="result-actions" *ngIf="summary.status === 'Rejeitado'">
        <button class="btn-history" (click)="goToHistory()">
          üìã Ver no Hist√≥rico
        </button>
      </div>
    </div>
  </section>

  <div class="status-banner error" *ngIf="errorMessage()">
    <span>‚ö†Ô∏è {{ errorMessage() }}</span>
  </div>

  <!-- Modal de Upload de Documento -->
  <div class="modal-overlay" *ngIf="showUploadModal()" (click)="closeUploadModal()">
    <div class="upload-modal-wrapper" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeUploadModal()">‚úï</button>
      <div class="upload-modal-content">
        <div class="upload-modal-header">
          <div class="upload-modal-icon">üìÑ</div>
          <h3>Upload de Documento</h3>
          <p>Fa√ßa upload de um documento (RG/CNH) para compara√ß√£o facial.</p>
        </div>

        <div class="upload-modal-body">
          <div class="document-input-modal">
            <label class="upload-button-modal" [class.uploading]="isUploadingDocument()">
              <input 
                type="file" 
                accept="image/*" 
                (change)="onDocumentSelected($event)" 
                hidden 
                [disabled]="isUploadingDocument()" />
              <span *ngIf="!isUploadingDocument()">üìÑ Selecionar documento</span>
              <span *ngIf="isUploadingDocument()" class="upload-loading">
                <span class="upload-spinner"></span>
                Enviando e validando documento...
              </span>
            </label>

            <div class="document-info-modal" *ngIf="documentInfo() && !isUploadingDocument(); else noDocumentModal">
              <div *ngIf="documentInfo() as info">
                <strong>{{ info.name }}</strong>
                <p>{{ info.sizeKb | number:'1.0-0' }} KB</p>
              </div>
              <button class="btn-ghost-modal" type="button" (click)="clearDocument()">Remover</button>
            </div>
            <ng-template #noDocumentModal>
              <p class="document-placeholder-modal" *ngIf="!isUploadingDocument()">Nenhum documento selecionado.</p>
            </ng-template>

            <!-- Informa√ß√£o de compress√£o -->
            <div class="compression-info-modal" *ngIf="compressionInfo() && !isUploadingDocument()">
              <div class="compression-badge-modal" *ngIf="compressionInfo() as compInfo">
                <span>üì¶</span>
                <span>Comprimido: {{ compInfo.original }} KB ‚Üí {{ compInfo.compressed }} KB ({{ compInfo.reduction }}% menor)</span>
              </div>
            </div>

            <!-- Mensagem de valida√ß√£o -->
            <div class="document-validation-modal" *ngIf="documentValidationMessage() && isDocumentValid() === false && !isUploadingDocument()">
              <div class="validation-badge-modal invalid">
                <span>‚ùå</span>
                {{ documentValidationMessage() }}
              </div>
              <div *ngIf="documentScore() !== null" class="document-score-modal">
                Score: {{ documentScore() | number:'1.0-0' }}%
              </div>
            </div>

            <!-- Mensagem de sucesso -->
            <div class="document-validation-modal" *ngIf="isDocumentValid() === true && !isUploadingDocument()">
              <div class="validation-badge-modal valid">
                <span>‚úÖ</span>
                Documento v√°lido! Aguarde...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-capture-official-liveness
    #livenessComponent
    [documentFileSignal]="documentFile"
    [documentS3PathSignal]="documentS3Path"
    [documentUrlSignal]="documentUrl"
    [documentKeySignal]="documentKey"
    [documentScoreSignal]="documentScore"
    [documentAnalysisSignal]="documentAnalysis"
    [isDocumentValidSignal]="isDocumentValid"
    [documentValidationMessageSignal]="documentValidationMessage"
    [lastSummarySignal]="lastSummary"
    [errorMessageSignal]="errorMessage">
  </app-capture-official-liveness>
</div>

