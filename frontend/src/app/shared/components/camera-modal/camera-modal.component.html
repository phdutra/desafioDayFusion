<!-- Modal Fullscreen da C√¢mera -->
<div class="camera-modal" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-content-fullscreen">
    <button class="modal-cancel" (click)="closeModal()">
      ‚úï Cancelar
    </button>
    
    <div class="camera-wrapper-fullscreen">
      <!-- V√≠deo fullscreen (para 2D) -->
      <video 
        #videoElement 
        autoplay 
        playsinline 
        muted 
        class="camera-video-fullscreen"
        *ngIf="mode === '2d'"
      ></video>
      
      <!-- M√°scara de captura (apenas para 2D) -->
      <div class="camera-mask-overlay" *ngIf="mode === '2d'"></div>
      
      <!-- Overlay de c√¢mera (2D com detec√ß√£o facial) -->
      <div class="camera-overlay-fullscreen" *ngIf="cameraReady && mode === '2d'">
        <div class="capture-circle-fullscreen">
          <div class="alignment-guide-fullscreen vertical-line"></div>
          <div class="alignment-guide-fullscreen horizontal-line"></div>
          
          <div class="progress-ring-container">
            <svg class="progress-ring-fullscreen" viewBox="0 0 300 300">
              <circle class="progress-ring-circle"
                      cx="150" cy="150"
                      r="145"
                      fill="none"
                      stroke="#22c55e"
                      stroke-width="8"
                      [attr.stroke-dasharray]="progressDashArray"
                      [attr.stroke-dashoffset]="progressDashOffset"
                      stroke-linecap="round"
                      transform="rotate(-90 150 150)"/>
            </svg>
          </div>
        </div>
        
        <div class="detection-status">
          <span class="status-icon">{{ detectionStatus === 'ready' ? '‚úÖ' : 'üë§' }}</span>
          <span class="status-text">{{ getDetectionStatusText() }}</span>
        </div>
        
        <button class="capture-btn-fullscreen" 
                (click)="capturePhoto()" 
                [class.ready]="detectionStatus === 'ready'"
                [class.disabled]="detectionStatus !== 'ready'">
          <div class="capture-btn-inner-fullscreen"></div>
        </button>
      </div>

      <!-- Overlay de c√¢mera (3D com liveness) -->
      <div class="camera-overlay-fullscreen" *ngIf="mode === '3d'">
        <!-- Efeito de vinheta para escurecer as laterais e focar no rosto -->
        <div class="vignette-overlay-3d"></div>
        
        <!-- Layout estilizado: C√≠rculo branco central com anel de progresso -->
        <div class="liveness-container-3d">
          <!-- Anel de progresso circular com segmentos (ao redor do c√≠rculo) -->
          <div class="progress-ring-segments-3d">
            <svg class="progress-segments-svg" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
              <line 
                *ngFor="let seg of getProgressSegments(); trackBy: trackByIndex"
                [attr.x1]="seg.x1"
                [attr.y1]="seg.y1"
                [attr.x2]="seg.x2"
                [attr.y2]="seg.y2"
                [attr.stroke]="seg.isActive ? '#22c55e' : 'rgba(255, 255, 255, 0.6)'"
                [attr.stroke-width]="seg.isActive ? '8' : '6'"
                stroke-linecap="round"
                [attr.opacity]="seg.isActive ? '1' : '0.8'"
                [class.active]="seg.isActive"
                [style.filter]="(livenessProgress === 100 && seg.isActive) ? 'drop-shadow(0 0 6px rgba(34, 197, 94, 1))' : ''"
              />
            </svg>
          </div>
          
          <!-- C√≠rculo branco central (m√°scara) com v√≠deo dentro -->
          <div class="face-mask-circle-3d">
            <!-- V√≠deo recortado em c√≠rculo (sempre renderizado no modo 3D para ViewChild funcionar) -->
            <div class="face-video-mask">
              <video 
                #videoElement3d 
                autoplay 
                playsinline 
                muted 
                class="face-video-clipped"
                [style.opacity]="cameraReady ? '1' : '0'"
              ></video>
            </div>
            
            <!-- Linhas de guia (cruz no centro) -->
            <div class="alignment-guide-inner vertical-line"></div>
            <div class="alignment-guide-inner horizontal-line"></div>
          </div>
          
          <!-- For√ßar atualiza√ß√£o do SVG quando progresso mudar (trigger de mudan√ßa) -->
          <div style="display: none; width: 0; height: 0; opacity: 0;">{{ livenessProgress }}{{ currentPhase }}{{ currentLivenessStep }}{{ faceDetected }}{{ sessionActive }}</div>
        </div>

        <!-- Indicador de etapa do liveness (direita, esquerda, piscar/sorrir) -->
        <div class="liveness-step-indicator" *ngIf="sessionActive && currentPhase === 'recording' && currentLivenessStep !== 'center'">
          <div class="step-content" [class.step-right]="currentLivenessStep === 'right'" 
               [class.step-left]="currentLivenessStep === 'left'"
               [class.step-blink-smile]="currentLivenessStep === 'blink_smile'"
               [class.step-completed]="currentLivenessStep === 'completed'">
            <div class="step-icon-text-container">
              <div class="step-icon-large">
                <span *ngIf="currentLivenessStep === 'right'">‚û°Ô∏è</span>
                <span *ngIf="currentLivenessStep === 'left'">‚¨ÖÔ∏è</span>
                <span *ngIf="currentLivenessStep === 'blink_smile'">üëÅÔ∏èüòä</span>
                <span *ngIf="currentLivenessStep === 'completed'">‚úì</span>
              </div>
              <div class="step-text-large">{{ getLivenessStepText() }}</div>
            </div>
            
            <!-- Bot√£o de avan√ßo manual (vis√≠vel apenas se n√£o for completed) -->
            <div class="manual-advance-container" *ngIf="currentLivenessStep !== 'completed'">
              <button 
                class="manual-advance-btn" 
                (click)="advanceStepManually()"
                type="button"
                title="Avan√ßar para pr√≥xima etapa manualmente">
                ‚è≠Ô∏è Avan√ßar
              </button>
            </div>
          </div>
        </div>

        <!-- Controles na parte inferior -->
        <div class="liveness-controls-bottom">
          <div class="liveness-info" *ngIf="!sessionActive && !faceDetected">
            <p class="liveness-info-text">üì∏ Valida√ß√£o em tempo real</p>
            <p class="liveness-info-hint">Siga as instru√ß√µes de voz para posicionar corretamente</p>
          </div>
          
          <div class="liveness-info-ready" *ngIf="!sessionActive && faceDetected">
            <p class="liveness-info-text">‚úì Tudo certo! Iniciando automaticamente...</p>
          </div>

          <!-- Bot√£o redesenhado -->
          <button 
            class="btn-liveness-start btn-start-large" 
            [class.ready]="faceDetected"
            [class.disabled]="!faceDetected || validatingPosition"
            *ngIf="!sessionActive"
            (click)="startLiveness3D()"
            [disabled]="!faceDetected || validatingPosition">
            <span class="btn-icon-large">‚ñ∂</span>
            <span class="btn-text-large">Iniciar Verifica√ß√£o 3D</span>
            <span class="btn-subtitle" *ngIf="!faceDetected">Aguarde valida√ß√£o...</span>
          </button>

          <div class="liveness-active-status" *ngIf="sessionActive">
            <div class="active-status-badge">
              <div class="status-pulse-active"></div>
              <span *ngIf="currentPhase === 'recording'">Grava√ß√£o em andamento... Finaliza√ß√£o autom√°tica</span>
              <span *ngIf="currentPhase === 'processing'">Processando resultados...</span>
              <span *ngIf="currentPhase === 'completed'">Conclu√≠do</span>
            </div>
            
            <button class="btn-liveness-stop" (click)="stopLiveness()" *ngIf="currentPhase !== 'completed'">
              <span class="btn-liveness-icon">‚èπ</span>
              <span>Finalizar Manualmente</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Loading overlay -->
      <div class="overlay-loading" *ngIf="cameraInitializing">
        <div class="overlay-content-loading">
          <div class="loading-spinner"></div>
          <p>Iniciando c√¢mera...</p>
        </div>
      </div>

      <!-- Tela de processamento de resultados (estilosa) -->
      <div class="overlay-processing-results" *ngIf="processingResults">
        <div class="processing-results-content">
          <div class="processing-animation">
            <div class="processing-icon-wrapper">
              <div class="processing-icon">
                <svg viewBox="0 0 100 100" class="processing-svg">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(34, 197, 94, 0.3)" stroke-width="4" />
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#22c55e" stroke-width="4" 
                          [attr.stroke-dasharray]="251.2"
                          [attr.stroke-dashoffset]="251.2 - (251.2 * processingProgress / 100)"
                          stroke-linecap="round"
                          transform="rotate(-90 50 50)"
                          class="processing-circle" />
                </svg>
                <div class="processing-checkmark" *ngIf="processingProgress >= 100">‚úì</div>
              </div>
            </div>
            
            <h2 class="processing-title">Gerando Resultados</h2>
            <p class="processing-subtitle">Processando an√°lise facial e verificando liveness...</p>
            
            <!-- Barra de progresso animada -->
            <div class="progress-bar-container">
              <div class="progress-bar-background">
                <div class="progress-bar-fill" [style.width.%]="processingProgress">
                  <div class="progress-bar-shine"></div>
                </div>
              </div>
              <div class="progress-percentage">{{ processingProgress }}%</div>
            </div>
            
            <!-- Mensagens de status -->
            <div class="processing-status-messages">
              <div class="status-message" *ngIf="processingProgress < 30">
                <span class="status-dot"></span>
                <span>Conectando com AWS Rekognition...</span>
              </div>
              <div class="status-message" *ngIf="processingProgress >= 30 && processingProgress < 60">
                <span class="status-dot"></span>
                <span>Processando frames de v√≠deo...</span>
              </div>
              <div class="status-message" *ngIf="processingProgress >= 60 && processingProgress < 90">
                <span class="status-dot"></span>
                <span>Analisando liveness e gerando imagens...</span>
              </div>
              <div class="status-message" *ngIf="processingProgress >= 90 && processingProgress < 100">
                <span class="status-dot"></span>
                <span>Finalizando an√°lise...</span>
              </div>
              <div class="status-message success" *ngIf="processingProgress >= 100">
                <span class="status-dot success"></span>
                <span>An√°lise conclu√≠da!</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Erro overlay -->
      <div class="overlay-error" *ngIf="error && !cameraInitializing && !processingResults">
        <div class="overlay-content-error">
          <span class="error-icon">‚ö†Ô∏è</span>
          <p class="error-message">{{ error }}</p>
          <button class="btn btn-secondary" (click)="initializeCamera()">
            Tentar Novamente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

