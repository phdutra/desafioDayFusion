<div class="review" *ngIf="livenessResult">
  <section class="review__left">
    <h3>Resumo da Verifica√ß√£o</h3>

    <div class="review__metrics">
      <div class="metric">
        <span class="metric__label">Session ID</span>
        <code>{{ livenessResult.sessionId }}</code>
      </div>

      <div class="metric">
        <span class="metric__label">Liveness Score</span>
        <span class="metric__value">
          {{ livenessResult.confidenceScore | number : '1.0-2' }}%
        </span>
      </div>

      <div class="metric" *ngIf="livenessResult.raw?.backendAnalysis?.documentScore !== undefined || livenessResult.raw?.documentScore !== undefined">
        <span class="metric__label">Document Score</span>
        <span class="metric__value">
          {{ (livenessResult.raw?.backendAnalysis?.documentScore ?? livenessResult.raw?.documentScore ?? 0) | number : '1.0-2' }}%
        </span>
      </div>

      <div class="metric" *ngIf="matchResult">
        <span class="metric__label">Match Documento</span>
        <span class="metric__value">
          {{ matchResult.bestMatchScore | number : '1.0-2' }}%
        </span>
      </div>

      <div class="metric" *ngIf="matchResult">
        <span class="metric__label">Score Final DayFusion</span>
        <span class="metric__value metric__value--final">
          {{ matchResult.finalScore | number : '1.0-2' }}%
        </span>
      </div>

      <div class="metric" *ngIf="!matchResult && (livenessResult.raw?.backendAnalysis?.identityScore !== undefined)">
        <span class="metric__label">Score Final DayFusion</span>
        <span class="metric__value metric__value--final">
          {{ livenessResult.raw?.backendAnalysis?.identityScore | number : '1.0-2' }}%
        </span>
      </div>
    </div>
  </section>

  <section class="review__right">
    <h3>Imagens utilizadas</h3>

    <div class="review__thumbs-wrapper" *ngIf="livenessResult.auditImages?.length">
      <div class="review__thumbs">
        <div
          class="thumb"
          *ngFor="let img of livenessResult.auditImages">
          <!-- Se tiver URL assinado direto -->
          <img *ngIf="img.url" [src]="img.url" alt="Frame liveness" />

          <!-- Se estiver usando rota interna para servir imagens do S3 -->
          <img *ngIf="!img.url"
               [src]="'/api/media/liveness-frame?bucket=' + img.bucket + '&key=' + img.key"
               alt="Frame liveness" />
        </div>
      </div>

      <div class="review__doc">
        <h4>Documento</h4>
        <div *ngIf="resolvedDocumentUrl; else noDocumentImage" class="document-image-wrapper">
          <img
            [src]="resolvedDocumentUrl"
            alt="Documento"
            (error)="onDocumentImageError($event)"
            loading="lazy"
          />
        </div>
        <ng-template #noDocumentImage>
          <div class="document-placeholder">
            <span class="placeholder-icon">üìÑ</span>
            <p>Documento n√£o dispon√≠vel</p>
            <code *ngIf="documentImageS3Path" class="document-path">{{ documentImageS3Path }}</code>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="review__loading" *ngIf="isLoadingMatch">
      <span class="spinner"></span>
      <p>Calculando match do rosto com o documento...</p>
    </div>

    <!-- Status Final -->
    <div class="review__status" [class.approved]="status === 'Aprovado'" 
         [class.rejected]="status === 'Rejeitado'" 
         [class.review]="status === 'Revisar'">
      <div class="status-content">
        <span class="status-icon">
          {{ status === 'Aprovado' ? '‚úÖ' : status === 'Rejeitado' ? '‚ùå' : 'üîç' }}
        </span>
        <div class="status-text">
          <h3>Status Final: {{ status }}</h3>
          <p *ngIf="status === 'Aprovado'">Verifica√ß√£o aprovada com sucesso!</p>
          <p *ngIf="status === 'Rejeitado'">
            Verifica√ß√£o rejeitada. 
            <span *ngIf="livenessResult.raw?.backendAnalysis?.observacao">
              {{ livenessResult.raw?.backendAnalysis?.observacao }}
            </span>
            <span *ngIf="!livenessResult.raw?.backendAnalysis?.observacao">
              Verifique os crit√©rios.
            </span>
          </p>
          <p *ngIf="status === 'Revisar'">Verifica√ß√£o requer an√°lise manual.</p>
        </div>
      </div>
    </div>

    <div class="review__actions">
      <button class="btn-secondary" (click)="cancel()">Cancelar</button>
      <button class="btn-primary" (click)="confirm()" [disabled]="isSaving">
        {{ isSaving ? 'Salvando...' : 'Confirmar Verifica√ß√£o' }}
      </button>
    </div>
  </section>
</div>

